<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Painel | Contratantes & Fornecedores</title>
<meta name="color-scheme" content="light dark" />
<style>
:root{
  --bg:#0b0c10; --card:#151821; --muted:#94a3b8; --text:#e5e7eb; --border:#252a35;
  --accent:#22c55e; --accent-iris:#3b82f6; --accent-ded:#a855f7;
  --red:#ef4444; --green:#22c55e; --blue:#3b82f6;
  color-scheme: light dark;
}
@media (prefers-color-scheme: light){
  :root{ --bg:#f6f7fb; --card:#fff; --muted:#475569; --text:#0f172a; --border:#e5e7eb; }
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:14px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--text); background: radial-gradient(1200px 600px at 10% -10%, #151a26 0%, transparent 60%), var(--bg);
  min-width:320px;
}
/* Topo */
.topbar{
  display:flex; gap:16px; align-items:center; justify-content:space-between;
  padding:20px clamp(16px,4vw,36px); border-bottom:1px solid var(--border);
  background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%);
  position:sticky; top:0; z-index:10; backdrop-filter: blur(6px);
}
.topbar h1{margin:0; font-size:clamp(18px, 2.5vw, 24px)}
.actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.actions input, .actions select{
  background: var(--card); color:var(--text);
  border:1px solid var(--border); border-radius:10px; padding:10px 12px;
  outline:none; min-width: 200px;
}
.actions select{min-width: 170px}
/* Layout */
.container{padding:24px clamp(16px,4vw,36px); display:grid; gap:24px}
/* Cards */
.cards{display:grid; gap:14px; grid-template-columns: repeat(5, minmax(160px,1fr));}
.card{
  background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
  display:flex; flex-direction:column; gap:6px; box-shadow:0 6px 20px rgba(0,0,0,.1);
}
.card.big{grid-column: span 2;}
.card.big.green .card-value{ color:var(--accent); font-size:36px }
.card-title{color:var(--muted); font-weight:600; font-size:12px; letter-spacing:.3px}
.card-value{font-size:28px; font-weight:700}
.card-row{display:flex; align-items:center; gap:10px}
.progress{width:100%; height:8px; background:rgba(148,163,184,.2); border-radius:8px; overflow:hidden; border:1px solid var(--border)}
.progress div{height:100%; width:0}
#barIris{background: var(--accent-iris)}
#barDedalus{ background: var(--green); }
/* Tabela */
.table-wrap{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px}
.tabs{display:flex; gap:8px; padding:8px}
.tab{background:transparent; border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer}
.tab.active{background: rgba(148,163,184,.15)}
.table-head{display:flex; align-items:baseline; justify-content:space-between; gap:10px; padding:6px 8px 12px 8px}
.table-head h2{margin:0; font-size:18px}
.table-head small{color:var(--muted)}
.table-responsive{overflow:auto; border-radius:10px; border:1px solid var(--border)}
table{width:100%; border-collapse: separate; border-spacing:0}
thead th{
  position: sticky; top:0; z-index: 1;
  background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 60%), var(--card);
  border-bottom:1px solid var(--border); color:var(--muted); text-align:left;
  padding:10px 12px; font-size:12px; letter-spacing:.3px; cursor:pointer; user-select:none;
}
tbody td{padding:10px 12px; border-bottom:1px dashed var(--border); white-space:nowrap}
tbody tr:hover{background: rgba(148,163,184,.08)}
.col-status{display:flex; align-items:center; gap:10px}
.status-dot{width:10px; height:10px; border-radius:50%; display:inline-block; flex:none}
.status-dot.red{background: var(--red)}
.status-dot.green{background: var(--green)}
.status-dot.blue{background: var(--blue)}
.status-text{font-weight:600}
/* Rodapé */
.footer{padding:30px clamp(16px,4vw,36px); color:var(--muted); display:flex; align-items:center; justify-content:center; border-top:1px solid var(--border)}
/* Responsivo */
@media (max-width: 1200px){ .cards{grid-template-columns: repeat(3, 1fr)} .card.big{grid-column: span 3} }
@media (max-width: 800px){ .cards{grid-template-columns: repeat(2, 1fr)} .card.big{grid-column: span 2} }
@media (max-width: 560px){
  .cards{grid-template-columns: 1fr}
  thead th:nth-child(5),tbody td:nth-child(5),
  thead th:nth-child(6),tbody td:nth-child(6),
  thead th:nth-child(7),tbody td:nth-child(7){display:none}
}
</style>
</head>
<body>
  <header class="topbar">
    <h1>Painel Aeromédica</h1>
    <div class="actions">
      <input id="searchInput" type="search" placeholder="Buscar por nome, CNPJ, grupo..." aria-label="Buscar" />
      <select id="statusFilter" aria-label="Filtrar por status">
        <option value="">Todos os status</option>
        <option value="nao_treinado">Não treinado</option>
        <option value="treinado">Treinado</option>
        <option value="em_uso">Em uso</option>
      </select>
      <select id="listaFilter" aria-label="Filtrar por lista">
        <option value="">Contratantes & Fornecedores</option>
        <option value="contratantes">Apenas Contratantes</option>
        <option value="fornecedores">Apenas Fornecedores</option>
      </select>
    </div>
  </header>

  <main class="container">
    <section class="cards">
      <div class="card big green">
        <div class="card-title">Meta Contratante</div>
        <div class="card-value" id="kpiMeta">70%</div>
      </div>

      <div class="card">
        <div class="card-title">Abertura IRIS</div>
        <div class="card-value" id="kpiIris">—</div>
        <div class="progress"><div id="barIris"></div></div>
      </div>

      <div class="card">
        <div class="card-title">Abertura Dedalus</div>
        <div class="card-value" id="kpiDedalus">—</div>
        <div class="progress"><div id="barDedalus"></div></div>
      </div>

      <div class="card">
        <div class="card-title">Total Contratantes</div>
        <div class="card-row">
          <span class="status-dot blue" aria-hidden="true"></span>
          <span class="card-value" id="kpiContrTotal">—</span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Total Fornecedores</div>
        <div class="card-row">
          <span class="status-dot green" aria-hidden="true"></span>
          <span class="card-value" id="kpiFornTotal">—</span>
        </div>
      </div>
    </section>

    <section class="table-wrap">
      <div class="tabs">
        <button class="tab active" data-tab="contratantes">Contratantes</button>
        <button class="tab" data-tab="fornecedores">Fornecedores</button>
      </div>

      <div class="table-head">
        <h2 id="tableTitle">Contratantes</h2>
        <small id="resultInfo">—</small>
      </div>

      <div class="table-responsive">
        <table id="mainTable">
          <thead>
            <tr>
              <th data-sort="status">Status</th>
              <th data-sort="nome">Nome</th>
              <th data-sort="cnpj">CNPJ</th>
              <th data-sort="grupo">Grupo</th>
              <th data-sort="responsavel">Responsável</th>
              <th data-sort="email">E-mail</th>
              <th data-sort="telefone">Telefone</th>
              <th data-sort="atualizado_em">Atualizado em</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="footer">
    <span>Atualize os dados em <code>data.json</code> e publique no GitHub Pages.</span>
  </footer>

  <template id="rowTemplate">
    <tr>
      <td class="col-status">
        <span class="status-dot" aria-hidden="true"></span>
        <span class="status-text"></span>
      </td>
      <td class="col-nome"></td>
      <td class="col-cnpj"></td>
      <td class="col-grupo"></td>
      <td class="col-responsavel"></td>
      <td class="col-email"></td>
      <td class="col-telefone"></td>
      <td class="col-atualizado"></td>
    </tr>
  </template>

<script>
/* ====== JS inline (lê data.json e monta o painel) ====== */
const STATUS_MAP = {
  "nao_treinado": { cls: "red",   label: "Não treinado" },
  "treinado":     { cls: "green", label: "Treinado" },
  "em_uso":       { cls: "blue",  label: "Em uso" }
};
let RAW = { contratantes: [], fornecedores: [], meta_contratante_pct: 70, progresso: {} };
let ACTIVE_TAB = "contratantes";
let sortState = { key: null, dir: 1 };

const $ = (s, c=document)=>c.querySelector(s);
const $$ = (s, c=document)=>Array.from(c.querySelectorAll(s));

document.addEventListener("DOMContentLoaded", async () => {
  const tableBody   = $("#tableBody");
  const rowTemplate = $("#rowTemplate");
  const resultInfo  = $("#resultInfo");

  // Carrega JSON (sem cache para facilitar atualização via GitHub Pages)
  try{
    const res = await fetch("data.json", { cache: "no-store" });
    if(!res.ok) throw new Error("Falha ao carregar data.json");
    RAW = await res.json();
  }catch(e){
    console.error(e);
  }

  // KPIs
  $("#kpiMeta").textContent = `${RAW.meta_contratante_pct ?? 70}%`;
  const iris = toNumber(RAW?.progresso?.volume_iris_pct);
  const deda = toNumber(RAW?.progresso?.volume_dedalus_pct);
  setKpi("#kpiIris", "#barIris", iris);
  setKpi("#kpiDedalus", "#barDedalus", deda);
  $("#kpiContrTotal").textContent = (RAW.contratantes||[]).length;
  $("#kpiFornTotal").textContent  = (RAW.fornecedores||[]).length;

  // Abas
  $$(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      $$(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      ACTIVE_TAB = btn.dataset.tab;
      $("#tableTitle").textContent = ACTIVE_TAB[0].toUpperCase()+ACTIVE_TAB.slice(1);
      render();
    });
  });

  // Ordenação por cabeçalho
  $$("thead th").forEach(th=>{
    th.addEventListener("click", ()=>{
      const key = th.dataset.sort;
      if(!key) return;
      if(sortState.key === key){ sortState.dir *= -1; } else { sortState.key = key; sortState.dir = 1; }
      render();
    });
  });

  // Filtros
  $("#searchInput").addEventListener("input", debounce(render, 150));
  $("#statusFilter").addEventListener("change", render);
  $("#listaFilter").addEventListener("change", e => {
    const v = e.target.value;
    if(v === "contratantes"){ ACTIVE_TAB = "contratantes"; }
    else if(v === "fornecedores"){ ACTIVE_TAB = "fornecedores"; }
    else{ /* ambos: mantém a aba atual, mas a busca contempla a aba visível */ }
    $("#tableTitle").textContent = ACTIVE_TAB[0].toUpperCase()+ACTIVE_TAB.slice(1);
    $$(".tab").forEach(b=>b.classList.toggle("active", b.dataset.tab===ACTIVE_TAB));
    render();
  });

  render();

  function render(){
    const query  = $("#searchInput").value.trim().toLowerCase();
    const st     = $("#statusFilter").value;
    const source = ACTIVE_TAB === "fornecedores" ? (RAW.fornecedores||[]) : (RAW.contratantes||[]);

    let rows = source.filter(item => {
      const hay = `${item.nome||""} ${item.cnpj||""} ${item.grupo||""} ${item.responsavel||""} ${item.email||""}`.toLowerCase();
      const okQuery  = !query || hay.includes(query);
      const okStatus = !st || (item.status === st);
      return okQuery && okStatus;
    });

    if(sortState.key){
      const k = sortState.key;
      rows.sort((a,b)=>{
        const av = (a[k] ?? "").toString().toLowerCase();
        const bv = (b[k] ?? "").toString().toLowerCase();
        if(av < bv) return -1 * sortState.dir;
        if(av > bv) return  1 * sortState.dir;
        return 0;
      });
    }

    tableBody.innerHTML = "";
    for(const item of rows){
      const tr = rowTemplate.content.firstElementChild.cloneNode(true);
      const sm = STATUS_MAP[item.status] || { cls:"", label: (item.status||"—") };
      $(".status-dot", tr).classList.add(sm.cls);
      $(".status-text", tr).textContent = sm.label;
      $(".col-nome", tr).textContent = item.nome || "—";
      $(".col-cnpj", tr).textContent = item.cnpj || "—";
      $(".col-grupo", tr).textContent = item.grupo || "—";
      $(".col-responsavel", tr).textContent = item.responsavel || "—";
      $(".col-email", tr).textContent = item.email || "—";
      $(".col-telefone", tr).textContent = item.telefone || "—";
      $(".col-atualizado", tr).textContent = formatDate(item.atualizado_em) || "—";
      tableBody.appendChild(tr);
    }

    resultInfo.textContent = rows.length === 1 ? "1 resultado" : `${rows.length} resultados`;
  }
});

// Utils
function setKpi(txtSel, barSel, val){
  const txt = document.querySelector(txtSel);
  const bar = document.querySelector(barSel);
  if(val==null || isNaN(val)){ txt.textContent = "—"; bar.style.width = "0%"; return; }
  const pct = clamp(val, 0, 100);
  txt.textContent = pct.toFixed(1).replace(".", ",") + "%";
  bar.style.width = pct + "%";
}
function debounce(fn, wait=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }
function toNumber(v){ if(v==null) return null; const s=String(v).replace(",", "."); const n = Number(s); return isNaN(n) ? null : n; }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function formatDate(iso){ if(!iso) return ""; const d=new Date(iso); return isNaN(d)? String(iso): d.toLocaleDateString("pt-BR"); }
</script>
</body>
</html>



