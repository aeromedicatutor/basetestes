<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Painel de Contratantes</title>
<meta name="description" content="Painel est√°tico de contratantes e fornecedores alimentado por JSON no pr√≥prio reposit√≥rio.">
<style>
  /* ===== Reset b√°sico ===== */
  *, *::before, *::after { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; }
  body {
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background:
      radial-gradient(1200px 500px at 10% -10%, #fff4e5 0%, transparent 60%),
      radial-gradient(1000px 500px at 110% 110%, #ffe1c0 0%, transparent 60%),
      #fff7f0; /* laranja suave */
    color: #1f2937;
    line-height: 1.35;
    display: grid;
    place-items: center;
    padding: 2rem;
  }

  /* ===== Folha A4 central (responsiva) ===== */
  .sheet {
    width: min(100%, 900px);
    aspect-ratio: 1 / 1.4142; /* A4 */
    max-height: 95vh;
    background: #fff;
    border-radius: 18px;
    box-shadow:
      0 10px 30px rgba(24, 39, 75, 0.10),
      0 2px 8px rgba(24, 39, 75, 0.06);
    overflow: hidden;
    display: grid;
    grid-template-rows: auto auto 1fr auto;
  }

  @media print {
    body { background: #fff; }
    .sheet { width: 210mm; height: 297mm; max-height: unset; aspect-ratio: auto; box-shadow: none; border-radius: 0; }
    .toolbar { display: none; }
  }

  header {
    padding: 24px 28px 8px;
    background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
    border-bottom: 1px solid #eef2f7;
  }
  .title { display: flex; align-items: baseline; gap: .75rem; flex-wrap: wrap; }
  .title h1 { margin: 0; font-size: clamp(1.1rem, 1.2rem + 0.6vw, 1.6rem); font-weight: 800; letter-spacing: -0.02em; }
  .subtitle { color: #6b7280; font-size: .95rem; }

  .toolbar {
    display: flex; gap: .75rem; padding: 10px 24px 10px; align-items: center; border-bottom: 1px solid #eef2f7;
    background: #fff;
  }
  .search {
    flex: 1; display: flex; align-items: center; gap: .5rem;
    background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 12px; padding: .65rem .9rem;
  }
  .search input { width: 100%; border: none; background: transparent; outline: none; font-size: .95rem; }
  .version { font-size: .85rem; color: #6b7280; }

  main.content { padding: 18px 24px 24px; overflow: auto; }
  .card {
    border: 1px solid #eef2f7; border-radius: 16px; padding: 14px 14px 10px; margin-bottom: 14px; background: #fff;
    transition: border-color .2s, box-shadow .2s;
  }
  .card:hover { border-color: #e3e8f2; box-shadow: 0 6px 16px rgba(24,39,75,.06); }
  .row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: .75rem; }
  .row h3 { margin: 0; font-size: 1.04rem; letter-spacing: -0.01em; }
  .meta { display: flex; align-items: center; gap: .75rem; }
  .badge {
    font-variant-numeric: tabular-nums;
    background: #ecfdf5; color: #065f46; border: 1px solid #d1fae5;
    padding: .28rem .55rem; border-radius: 999px; font-size: .86rem; font-weight: 700;
  }
  .toggle { border: 1px solid #e5e7eb; background: #fff; border-radius: 10px; padding: .4rem .6rem; cursor: pointer; font-weight: 700; min-width: 2.3rem; text-align: center; }
  .progress { height: 8px; background: #f3f4f6; border-radius: 999px; overflow: hidden; margin-top: 10px; }
  .bar { height: 100%; width: 0%; background: linear-gradient(90deg, #4ade80, #16a34a); transition: width .5s ease; } /* verde */

  .details { display: none; padding-top: 12px; border-top: 1px dashed #e5e7eb; margin-top: 12px; }
  .details.open { display: block; }

  /* ===== fornecedores: 5 colunas (Fornecedor | Tipo | Cidade | Estados | Remo√ß√µes) ===== */
  .supplier-head, .supplier-row {
    display: grid; grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr; gap: .8rem; align-items: start;
  }
  .supplier-head {
    font-size: .85rem; color: #6b7280; margin-bottom: .5rem; padding: 0 .25rem .35rem;
    border-bottom: 1px dashed #e5e7eb;
  }

  /* Cada fornecedor como "item" com bloco suave */
  .supplier-row {
    background: #fbfbfc;
    border: 1px solid #eef2f7;
    border-radius: 12px;
    padding: .6rem .65rem;
  }
  .supplier-row + .supplier-row { margin-top: .6rem; }

  /* Chips padr√£o (cidades/estados/remo√ß√µes) */
  .chip {
    display: inline-block; padding: .25rem .6rem; border-radius: 999px; font-size: .8rem; line-height: 1;
    background: #f3f4f6; border: 1px solid #e5e7eb; margin-right: .35rem; margin-bottom: .35rem;
    white-space: nowrap;
  }

  /* ===== Bot√£o 'fake' (Fornecedor) ===== */
  .btn-supplier {
    display: inline-flex; align-items: center; justify-content: center;
    padding: .45rem .9rem;
    background: #059669;  /* verde */
    color: #fff;
    border: 1px solid rgba(255,255,255,.18);
    border-radius: 10px;
    font-weight: 700; font-size: .92rem; line-height: 1;
    box-shadow: 0 1px 0 rgba(0,0,0,.03), inset 0 -1px 0 rgba(0,0,0,.08);
    pointer-events: none; /* n√£o clic√°vel */
    user-select: text;    /* permite selecionar o texto */
  }

  /* ===== Subfiltro por contratante ===== */
  .subtoolbar { display:flex; align-items:center; gap:.5rem; margin: .25rem 0 .6rem; }
  .subfilter {
    flex:1; display:flex; align-items:center; gap:.5rem;
    background:#f3f4f6; border:1px solid #e5e7eb; border-radius:10px; padding:.45rem .6rem;
    font-size:.9rem;
  }
  .subfilter input { width:100%; border:0; background:transparent; outline:none; font-size:.9rem; }
  .subclear {
    border:0; background:#e5e7eb; border-radius:8px; padding:.2rem .5rem; cursor:pointer; font-weight:700;
  }
  .subcount { font-size:.82rem; color:#6b7280; }
  .subempty { margin-top:.5rem; }
  .subtoolbar .emoji { opacity:.8; }
  
  .foot { padding: 10px 24px 18px; color: #6b7280; font-size: .85rem; border-top: 1px solid #f1f5f9; background: #fcfcfd; }
  .empty { color: #6b7280; font-size: .95rem; padding: .75rem 0 .25rem; }
  .error { background: #fef2f2; color: #7f1d1d; border: 1px solid #fee2e2; padding: .75rem 1rem; border-radius: 10px; margin: 12px 0; }
</style>
</head>
<body>
  <div class="sheet" role="document" aria-label="Folha A4 com painel de contratantes">
    <header>
      <div class="title">
        <h1>Painel de Contratantes</h1>
        <span class="subtitle">Com fornecedores treinados para utilizar geolocaliza√ß√£o</span>
      </div>
    </header>

    <div class="toolbar">
      <div class="search" title="Filtrar contratantes">
        üîé <input id="filter" placeholder="Filtrar(ex.: Unimed, Vivest, PASA)" />
      </div>
      <div class="version" id="versionLabel" title="Mude a vers√£o no script para for√ßar atualiza√ß√£o de cache">v2</div>
    </div>

    <main class="content">
      <div id="errors"></div>
      <div id="list"></div>
    </main>

    <div class="foot">
      Para mais informa√ß√µes <b>Consulte o DEDALUS</b>.
    </div>
  </div>

<script>
/* ===== Config =====
   Dica: altere DATA_VERSION quando mudar o JSON para "estourar" cache do navegador/CDN */
const DATA_VERSION = "v4";
const DATA_URL = `data/contratantes.json?v=${encodeURIComponent(DATA_VERSION)}`;

document.getElementById("versionLabel").textContent = DATA_VERSION;

/* ===== Helpers ===== */
function parsePct(val) {
  if (val === null || val === undefined || val === "----") return null;
  if (typeof val === "number") return val;
  // aceita "16,74%" ou "16.74" ‚Ä¶
  const s = String(val).replace("%","").replace(",",".").trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

function createEl(tag, props = {}, html = "") {
  const el = document.createElement(tag);
  Object.entries(props).forEach(([k, v]) => {
    if (k === "className") el.className = v;
    else if (k in el) el[k] = v;
    else el.setAttribute(k, v);
  });
  if (html) el.innerHTML = html;
  return el;
}

const toArray = (val) => {
  if (val == null || val === "") return [];
  if (Array.isArray(val)) return val;
  return String(val).split(",").map(s => s.trim()).filter(Boolean);
};
const renderChips = (values) =>
  (values.length ? values.map(v => `<span class="chip">${String(v)}</span>`).join("") : `<span class="chip">‚Äî</span>`);

/* ===== Render ===== */
const listEl = document.getElementById("list");
const errEl = document.getElementById("errors");
let data = [];

function render(filterText = "") {
  listEl.innerHTML = "";
  const ft = filterText.trim().toLowerCase();

  // ordenar por pct desc, nulos por √∫ltimo
  const arr = [...data].sort((a,b) => {
    const ap = parsePct(a.pct), bp = parsePct(b.pct);
    if (ap == null && bp == null) return a.nome.localeCompare(b.nome);
    if (ap == null) return 1;
    if (bp == null) return -1;
    return bp - ap;
  });

  const filtered = arr.filter(c => !ft || c.nome.toLowerCase().includes(ft));
  if (!filtered.length) {
    listEl.appendChild(createEl("div", {className:"empty"}, "Nenhum contratante encontrado."));
    return;
  }

  filtered.forEach(c => listEl.appendChild(makeCard(c)));
}

function makeCard(c) {
  const pct = parsePct(c.pct);
  const id = "sec_" + btoa(c.nome).replace(/=/g,"");

  const card = createEl("div", {className:"card", role:"region", "aria-label": c.nome});
  const header = createEl("div", {className:"row"});
  const h3 = createEl("h3", {}, c.nome);
  const meta = createEl("div", {className:"meta"});
  const badge = createEl("span", {className:"badge"}, pct==null ? "‚Äî" : pct.toLocaleString("pt-BR", {minimumFractionDigits:2, maximumFractionDigits:2}) + "%");
  const toggle = createEl("button", {className:"toggle", "aria-controls": id, "aria-expanded":"false"}, "+");

  meta.appendChild(badge);
  meta.appendChild(toggle);
  header.appendChild(h3);
  header.appendChild(meta);

  const progress = createEl("div", {className:"progress"});
  const bar = createEl("div", {className:"bar"});
  progress.appendChild(bar);

  const details = createEl("div", {className:"details", id});

  /* --- Cabe√ßalho das colunas --- */
  const head = createEl("div", {className:"supplier-head"}, `
    <div><strong>Fornecedor</strong></div>
    <div><strong>Tipo</strong></div>
    <div><strong>Cidade</strong></div>
    <div><strong>Estados</strong></div>
    <div><strong>Remo√ß√µes</strong></div>
  `);
  details.appendChild(head);

  /* --- Linhas de fornecedores + subfiltro local --- */
  if (Array.isArray(c.fornecedores) && c.fornecedores.length) {
    const rows = [];

    c.fornecedores.forEach(grupo => {
      const fornecedorVal = String(grupo.fornecedor ?? "").trim() || "‚Äî";
      const especifico = String(grupo.especifico ?? "").trim() || "‚Äî";
      const cidades = toArray(grupo.cidade ?? grupo.cidades);
      const estados = toArray(grupo.estados);
      const remocoesRaw = (grupo.remocoes !== undefined ? grupo.remocoes : grupo["remo√ß√µes"]);
      const remocoesArr = Array.isArray(remocoesRaw) ? remocoesRaw : toArray(remocoesRaw);
      const remocoesHtml = Number.isFinite(remocoesRaw)
        ? `<span class="chip">${remocoesRaw}</span>`
        : renderChips(remocoesArr);

      const row = createEl("div", {className:"supplier-row"});
      row.innerHTML = `
        <div><span class="btn-supplier">${fornecedorVal}</span></div>
        <div>${especifico}</div>
        <div>${renderChips(cidades)}</div>
        <div>${renderChips(estados)}</div>
        <div>${remocoesHtml}</div>
      `;
      /* texto pesquis√°vel (apenas fornecedor + cidades, conforme pedido) */
      const searchable = [fornecedorVal, ...cidades].join(" ").toLowerCase();
      row.dataset.search = searchable;

      details.appendChild(row);
      rows.push(row);
    });

    /* Mensagem quando o subfiltro n√£o encontra nada */
    const subEmpty = createEl("div", {className:"empty subempty", style:"display:none;"}, "Nenhum fornecedor coincide com o filtro.");
    details.appendChild(subEmpty);

    /* Subtoolbar com input de filtro local e contador */
    const subtoolbar = createEl("div", {className:"subtoolbar"});
    const subfilter = createEl("div", {className:"subfilter"});
    const icon = createEl("span", {className:"emoji"}, "üîé");
    const input = createEl("input", {type:"search", placeholder:"Filtrar fornecedor/cidade‚Ä¶", "aria-label":"Filtrar fornecedores deste contratante"});
    const clearBtn = createEl("button", {type:"button", className:"subclear", title:"Limpar filtro"}, "√ó");
    const count = createEl("span", {className:"subcount"});

    subfilter.appendChild(icon);
    subfilter.appendChild(input);
    subfilter.appendChild(clearBtn);
    subtoolbar.appendChild(subfilter);
    subtoolbar.appendChild(count);

    /* insere a subtoolbar acima do cabe√ßalho das colunas */
    details.insertBefore(subtoolbar, head);

    const applySubfilter = () => {
      const q = input.value.trim().toLowerCase();
      const terms = q.split(/\s+/).filter(Boolean);
      let vis = 0;
      rows.forEach(row => {
        const ok = terms.length === 0 || terms.every(t => row.dataset.search.includes(t));
        row.style.display = ok ? "grid" : "none";
        if (ok) vis++;
      });
      subEmpty.style.display = vis ? "none" : "block";
      count.textContent = terms.length ? `${vis}/${rows.length}` : `${rows.length} fornecedor${rows.length===1?"":"es"}`;
    };

    input.addEventListener("input", applySubfilter);
    clearBtn.addEventListener("click", () => { input.value = ""; applySubfilter(); });

    /* inicializa contador */
    applySubfilter();
  } else {
    details.appendChild(createEl("div", {className:"empty"}, "Nenhum fornecedor cadastrado neste contratante."));
  }

  /* --- Montagem --- */
  card.appendChild(header);
  card.appendChild(progress);
  card.appendChild(details);

  /* anima a barra */
  requestAnimationFrame(() => { bar.style.width = (pct == null ? 0 : Math.max(0, Math.min(100, pct))) + "%"; });

  /* toggle abre/fecha */
  toggle.addEventListener("click", () => {
    const open = details.classList.toggle("open");
    toggle.textContent = open ? "‚Äì" : "+";
    toggle.setAttribute("aria-expanded", String(open));
  });

  return card;
}

/* ===== Fetch do JSON est√°tico ===== */
async function load() {
  errEl.innerHTML = "";
  try {
    const res = await fetch(DATA_URL, {cache: "no-store"}); // ainda assim, use DATA_VERSION para bustar CDN
    if (!res.ok) throw new Error(`Falha ao carregar dados (${res.status})`);
    const json = await res.json();
    if (!Array.isArray(json)) throw new Error("JSON inv√°lido (esperado array)");
    data = json;
    render();
  } catch (e) {
    errEl.appendChild(createEl("div", {className:"error"}, "Erro ao carregar dados: " + e.message));
  }
}

/* Filtro global (contratantes) */
document.getElementById("filter").addEventListener("input", (e) => render(e.target.value));

load();
</script>
</body>
</html>
